<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gift Dice</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    header { display:flex; align-items:center; gap:12px; }
    h2 { margin: 0 0 8px 0; }
    #avatar { width:32px; height:32px; border-radius:50%; object-fit:cover; }
    #username { font-weight:600; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin: 12px 0; }
    button { padding:10px 14px; border:1px solid #ddd; border-radius:8px; cursor:pointer; }
    #players li { margin:4px 0; }
    #log { margin-top:10px; padding:8px; background:#f7f7f7; border:1px solid #eee; border-radius:8px; max-height:180px; overflow:auto; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; }
  </style>
</head>
<body>
  <header>
    <h2>Gift Dice — Mini App</h2>
    <img id="avatar" alt="" style="display:none"/>
    <span id="username"></span>
  </header>

  <div class="card">
    <div id="status">Загрузка…</div>
    <div class="row">
      <button id="btn-join">Войти в раунд</button>
      <button id="btn-lock">Закрыть набор</button>
      <button id="btn-roll">Бросить кубики</button>
      <button id="btn-reset">Сброс</button>
    </div>
    <h3>Игроки</h3>
    <ul id="players"></ul>
    <h3>Лог</h3>
    <div id="log"></div>
  </div>

 <script>
const API_BASE = "";
const $players = document.getElementById('players');
const $log = document.getElementById('log');
const $status = document.getElementById('status');
const $avatar = document.getElementById('avatar');
const $username = document.getElementById('username');

// dev-режим включается только параметром ?dev=1
const isDev = new URLSearchParams(location.search).get('dev') === '1';

function tgUserStrict() {
  // 1) пробуем взять реального пользователя из Telegram Mini App
  try {
    const tg = window.Telegram?.WebApp;
    const u = tg?.initDataUnsafe?.user;
    if (u && u.id) {
      return {
        id: Number(u.id),
        username: u.username || undefined,
        first_name: u.first_name || undefined,
        last_name: u.last_name || undefined,
        photo_url: u.photo_url || undefined
      };
    }
  } catch(e) {}

  // 2) если это не Telegram – разрешаем только в dev-режиме
  if (isDev) {
    let id = localStorage.getItem('demo_uid');
    if (!id) { id = String(Math.floor(Math.random()*1e9)); localStorage.setItem('demo_uid', id); }
    return { id: Number(id), username: 'guest_'+id.slice(-4) };
  }

  // 3) иначе – запрещаем
  return null;
}

async function api(path, body) {
  const res = await fetch((API_BASE + path), {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: body ? JSON.stringify(body) : "{}"
  });
  return res.json();
}
async function getState() {
  const res = await fetch('/api/state');
  return res.json();
}

function render(state){
  $status.textContent = `Round ${state.round_id} — ${state.status}` + (state.commit ? ` — commit ${state.commit.slice(0,12)}…` : "");
  $players.innerHTML = "";
  state.players.forEach(p=>{
    const r = state.rolls[String(p.id)];
    const li = document.createElement('li');
    li.textContent = `${p.username} — ${p.dice}` + (r ? ` → ${r}` : "");
    if (state.winner && state.winner === p.id) li.style.fontWeight = 'bold';
    $players.appendChild(li);
  });
  $log.innerHTML = state.log.map(l=>`<div>${l}</div>`).join('');
}

document.getElementById('btn-join').onclick = async ()=>{
  const u = tgUserStrict();
  if (!u) {
    alert('Откройте игру через кнопку бота в Telegram. (Для разработки можно открыть в браузере с ?dev=1)');
    return;
  }
  const display = u.username || [u.first_name, u.last_name].filter(Boolean).join(' ') || 'user';
  const body = { user_id: u.id, username: display, dev: isDev };
  const r = await api('/api/join', body);
  if (r.error) alert(r.error);
  render(await getState());
};
document.getElementById('btn-lock').onclick = async ()=>{
  const r = await api('/api/lock',{});
  if (r.error) alert(r.error);
  render(await getState());
};
document.getElementById('btn-roll').onclick = async ()=>{
  const r = await api('/api/roll',{});
  if (r.error) alert(r.error);
  render(await getState());
};
document.getElementById('btn-reset').onclick = async ()=>{
  await api('/api/reset',{});
  render(await getState());
};

// автообновление
setInterval(async ()=>{
  try { render(await getState()); } catch(e){}
}, 1200);

window.addEventListener('load', async ()=>{
  render(await getState());
  try { window.Telegram?.WebApp?.ready(); } catch(e){}
  const u = tgUserStrict();
  if (u) {
    const name = u.username || [u.first_name, u.last_name].filter(Boolean).join(' ') || '';
    if (name) $username.textContent = name;
    if (u.photo_url) {
      $avatar.src = u.photo_url; $avatar.style.display = 'block';
    }
  }
});
</script>

</body>
</html>
